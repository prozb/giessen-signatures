<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin – signatures.json Generator</title>
  <style>
    :root{
      --bgTop:#475569;
      --bgBot:#1e293b;

      --card: rgba(255,255,255,.10);
      --stroke: rgba(148,163,184,.45);

      --text: #f8fafc;
      --muted:#e2e8f0;

      --shadow: 0 20px 55px rgba(0,0,0,.30);

      --r-xl: 26px;
      --r-lg: 18px;

      --accent:#fb923c;
      --ok:#22c55e;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(circle at 15% 0%, rgba(251,146,60,.28), transparent 60%),
        radial-gradient(circle at 85% 0%, rgba(34,197,94,.20), transparent 60%),
        linear-gradient(180deg, var(--bgTop), var(--bgBot));
      display:flex;
      justify-content:center;
      padding:18px 12px 28px;
    }

    .shell{
      width:100%;
      max-width:900px;
      border:1px solid rgba(148,163,184,.55);
      border-radius:30px;
      box-shadow:var(--shadow);
      background:linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.06));
      backdrop-filter: blur(14px);
      overflow:hidden;
    }

    header{padding:16px 16px 10px}
    h1{font-size:1.1rem}
    p{margin-top:6px;color:var(--muted);font-size:.92rem;line-height:1.45}

    main{padding:12px 16px 18px}

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media(max-width:820px){.grid{grid-template-columns:1fr}}

    .card{
      border-radius: var(--r-xl);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.12);
      box-shadow: 0 14px 40px rgba(0,0,0,.18);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .card::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(to bottom right, rgba(255,255,255,.10), transparent 55%);
      opacity:.8;
      pointer-events:none;
    }

    .card h2{position:relative;z-index:1;font-size:1rem}
    .row{
      position:relative;z-index:1;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:560px){.row{grid-template-columns:1fr}}

    label{display:block;color:var(--muted);font-size:.8rem;margin-bottom:6px}
    input{
      width:100%;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.45);
      background:rgba(15,23,42,.25);
      color:var(--text);
      outline:none;
      font-size:.95rem;
    }
    input:focus{
      border-color: rgba(251,146,60,.70);
      box-shadow: 0 0 0 4px rgba(251,146,60,.12);
    }

    .btns{
      position:relative;z-index:1;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      border:1px solid rgba(148,163,184,.55);
      background: rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
    }
    button.primary{
      border-color: rgba(251,146,60,.75);
      background: linear-gradient(90deg, rgba(251,146,60,.18), rgba(251,146,60,.32));
    }
    button:hover{transform:translateY(-1px)}

    pre{
      position:relative;z-index:1;
      margin-top:10px;
      padding:12px;
      border-radius:16px;
      background: rgba(15,23,42,.25);
      border:1px solid rgba(148,163,184,.35);
      overflow:auto;
      color:#e0f2fe;
      font-size:.82rem;
      line-height:1.4;
      max-height:380px;
    }

    .msg{
      margin-top:10px;
      color:var(--muted);
      font-size:.9rem;
      position:relative;z-index:1;
    }
    .ok{color:var(--ok);font-weight:900}

    /* file input hidden */
    #fileInput{ display:none; }
  </style>
</head>

<body>
  <div class="shell">
    <header>
      <h1>Admin – signatures.json Generator (lokal)</h1>
      <p>
        Werte eintragen → <b>signatures.json herunterladen</b> → Datei im Projekt ersetzen → commit/push → GitHub Pages aktualisiert.
      </p>
    </header>

    <main>
      <div class="grid">
        <section class="card">
          <h2>Stadt Gießen</h2>
          <div class="row">
            <div>
              <label for="stadtCollected">Gesammelt</label>
              <input id="stadtCollected" type="number" min="0" step="1" value="10" />
            </div>
            <div>
              <label for="stadtMin">Minimum (Schwelle)</label>
              <input id="stadtMin" type="number" min="0" step="1" value="62" />
            </div>
            <div>
              <label for="stadtMax">Maximum (Ziel)</label>
              <input id="stadtMax" type="number" min="1" step="1" value="78" />
            </div>
          </div>

          <hr style="border:0;border-top:1px solid rgba(148,163,184,.25);margin:14px 0">

          <h2>Landkreis Gießen</h2>
          <div class="row">
            <div>
              <label for="kreisCollected">Gesammelt</label>
              <input id="kreisCollected" type="number" min="0" step="1" value="16" />
            </div>
            <div>
              <label for="kreisMin">Minimum (Schwelle)</label>
              <input id="kreisMin" type="number" min="0" step="1" value="42" />
            </div>
            <div>
              <label for="kreisMax">Maximum (Ziel)</label>
              <input id="kreisMax" type="number" min="1" step="1" value="55" />
            </div>
          </div>

          <div class="btns">
            <button id="btnOpen">JSON öffnen</button>
            <button class="primary" id="btnDownload">signatures.json herunterladen</button>
            <button id="btnNow">Zeitstempel jetzt</button>
            <button id="btnValidate">Validieren</button>
          </div>

          <input id="fileInput" type="file" accept="application/json,.json" />

          <div class="msg" id="msg">Status: —</div>
        </section>

        <section class="card">
          <h2>Vorschau</h2>
          <div class="row">
            <div>
              <label for="lastUpdated">lastUpdated (ISO)</label>
              <input id="lastUpdated" type="text" />
            </div>
            <div>
              <label for="note">Notiz (optional)</label>
              <input id="note" type="text" placeholder="z.B. Stand heute Abend" />
            </div>
          </div>

          <pre id="preview"></pre>
        </section>
      </div>
    </main>
  </div>

<script>
  const el = (id)=>document.getElementById(id);

  // merkt sich die alten collected-Werte aus geladener JSON
  const prev = {
    stadt: null,
    kreis: null
  };

  function isoNow(){
    const d = new Date();
    const tzOffsetMin = -d.getTimezoneOffset();
    const sign = tzOffsetMin >= 0 ? "+" : "-";
    const hh = String(Math.floor(Math.abs(tzOffsetMin)/60)).padStart(2,"0");
    const mm = String(Math.abs(tzOffsetMin)%60).padStart(2,"0");
    const local = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,19);
    return local + sign + hh + ":" + mm;
  }

  function num(v, fallback=0){
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
  }

  function calcDelta(id, currentCollected){
    const p = prev[id];
    if(p === null || p === undefined) return 0; // wenn kein altes JSON geladen wurde
    return currentCollected - p;
  }

  function buildJson(){
    const stadtCollected = num(el("stadtCollected").value, 0);
    const kreisCollected = num(el("kreisCollected").value, 0);

    const data = {
      lastUpdated: el("lastUpdated").value || isoNow(),
      note: el("note").value || "",
      campaigns: [
        {
          id: "stadt",
          name_de: "Stadt Gießen",
          name_uk: "Місто Гіссен",
          collected: stadtCollected,
          delta: calcDelta("stadt", stadtCollected),
          minGoal: num(el("stadtMin").value, 0),
          maxGoal: num(el("stadtMax").value, 50),
        },
        {
          id: "kreis",
          name_de: "Landkreis Gießen",
          name_uk: "Район Гіссен",
          collected: kreisCollected,
          delta: calcDelta("kreis", kreisCollected),
          minGoal: num(el("kreisMin").value, 0),
          maxGoal: num(el("kreisMax").value, 50),
        }
      ]
    };
    if(!data.note) delete data.note;
    return data;
  }

  function validate(data){
    const errs = [];
    const d = new Date(data.lastUpdated);
    if(Number.isNaN(d.getTime())) errs.push("lastUpdated ist kein gültiges Datum/ISO-String");

    for(const c of data.campaigns){
      if(!c.id) errs.push("campaign id fehlt");
      if(!(c.maxGoal > 0)) errs.push(`${c.id}: maxGoal muss > 0 sein`);
      if(c.minGoal < 0) errs.push(`${c.id}: minGoal darf nicht negativ sein`);
      if(c.minGoal > c.maxGoal) errs.push(`${c.id}: minGoal darf nicht größer als maxGoal sein`);
      if(c.collected < 0) errs.push(`${c.id}: collected darf nicht negativ sein`);
      if(!Number.isFinite(Number(c.delta))) errs.push(`${c.id}: delta ist ungültig`);
      if(c.collected > c.maxGoal * 3) errs.push(`${c.id}: collected wirkt zu groß (bitte prüfen)`);
    }
    return errs;
  }

  function renderPreview(){
    const data = buildJson();
    el("preview").textContent = JSON.stringify(data, null, 2);
    return data;
  }

  function downloadJson(){
    const data = renderPreview();
    const errs = validate(data);

    if(errs.length){
      el("msg").textContent = "⚠️ " + errs.join(" · ");
      return;
    }

    el("msg").innerHTML = "<span class='ok'>✅ OK.</span> Datei wird heruntergeladen…";

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "signatures.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(a.href), 1200);
  }

  function applyJsonToForm(json){
    // lastUpdated/note
    if(json.lastUpdated) el("lastUpdated").value = String(json.lastUpdated);
    if(json.note) el("note").value = String(json.note);

    // campaigns
    const camps = Array.isArray(json.campaigns) ? json.campaigns : [];
    const byId = Object.fromEntries(camps.filter(c => c && c.id).map(c => [c.id, c]));

    if(byId.stadt){
      const c = byId.stadt;
      el("stadtCollected").value = num(c.collected, 0);
      el("stadtMin").value = num(c.minGoal, 0);
      el("stadtMax").value = num(c.maxGoal, 50);
      prev.stadt = num(c.collected, 0);
    }

    if(byId.kreis){
      const c = byId.kreis;
      el("kreisCollected").value = num(c.collected, 0);
      el("kreisMin").value = num(c.minGoal, 0);
      el("kreisMax").value = num(c.maxGoal, 50);
      prev.kreis = num(c.collected, 0);
    }

    el("msg").innerHTML = "<span class='ok'>✅ JSON geladen.</span> Delta wird nun automatisch berechnet (neu - alt).";
    renderPreview();
  }

  async function openJsonFile(file){
    const text = await file.text();
    let json;
    try{
      json = JSON.parse(text);
    }catch(e){
      el("msg").textContent = "⚠️ Datei ist kein gültiges JSON.";
      return;
    }
    applyJsonToForm(json);
  }

  // init
  el("lastUpdated").value = isoNow();
  renderPreview();

  // watch changes
  const watch = [
    "stadtCollected","stadtMin","stadtMax",
    "kreisCollected","kreisMin","kreisMax",
    "lastUpdated","note"
  ];
  watch.forEach(id => el(id).addEventListener("input", renderPreview));

  el("btnNow").addEventListener("click", ()=>{
    el("lastUpdated").value = isoNow();
    renderPreview();
    el("msg").textContent = "Status: Zeitstempel aktualisiert.";
  });

  el("btnValidate").addEventListener("click", ()=>{
    const data = renderPreview();
    const errs = validate(data);
    el("msg").textContent = errs.length ? ("⚠️ " + errs.join(" · ")) : "✅ Validierung OK.";
  });

  el("btnDownload").addEventListener("click", downloadJson);

  // JSON öffnen
  el("btnOpen").addEventListener("click", ()=>{
    el("fileInput").value = "";
    el("fileInput").click();
  });

  el("fileInput").addEventListener("change", async (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    await openJsonFile(file);
  });
</script>
</body>
</html>
